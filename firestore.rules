rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPERS ---
    function isOwner(uid) {
      return request.auth != null && request.auth.uid == uid;
    }
    
    function isNotChangingFlags() {
      // Prevents the client from modifying flags.betaAccess or flags.pro
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(['flags']);
    }

    // --- USER PROFILE ---
    match /users/{uid} {
      allow read: if isOwner(uid);
      allow create: if isOwner(uid); 
      allow update: if isOwner(uid) && isNotChangingFlags();

      // --- SRS ITEMS SUBCOLLECTION ---
      match /items/{itemId} {
        allow read: if isOwner(uid);
        allow create, update: if isOwner(uid)
          // Tight bounds to prevent corrupted database writes
          && request.resource.data.surah >= 1 
          && request.resource.data.surah <= 114
          && request.resource.data.ayah >= 1
          && request.resource.data.ease >= 1.3 
          && request.resource.data.ease <= 2.7
          && request.resource.data.intervalDays >= 0 
          && request.resource.data.intervalDays <= 3650
          && request.resource.data.reps >= 0
          && request.resource.data.lapses >= 0;
          
        allow delete: if false; // Items should never be deleted, only suspended/reset
      }
    }

    // --- DENY BY DEFAULT ---
    // Closes all other paths and prevents wildcards
    match /{document=**} {
      allow read, write: if false;
    }
  }
}